<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="author" content="">
    <link rel="shortcut icon" href="images/favicon.png" type="">
    <title>Famms Admin Panel</title>
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Media Upload Configuration -->
    <script>
        window.CMS_CONFIG = {
            media_folder: "images/uploads",
            public_folder: "/images/uploads"
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .nav {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav button:hover {
            background: #2980b9;
        }
        
        .nav button.active {
            background: #e74c3c;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #229954;
        }
        
        /* Image Widget Styles */
        .image-widget {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .image-widget:hover {
            border-color: #27ae60;
            background: #f0f8f0;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 10px auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .image-upload-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s ease;
        }
        
        .image-upload-btn:hover {
            background: #229954;
        }
        
        .image-input {
            display: none;
        }
        
        .image-path {
            margin-top: 10px;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .product-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .product-info h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .product-info .price {
            color: #e74c3c;
            font-size: 20px;
            font-weight: bold;
            margin: 0 0 8px 0;
        }
        
        .product-info .category {
            color: #7f8c8d;
            font-size: 14px;
            margin: 0 0 12px 0;
        }
        
        .product-info .description {
            color: #34495e;
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 15px 0;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2980b9;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .add-product-btn {
            width: 100%;
            padding: 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .add-product-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        /* Product Form Modal */
        .product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .product-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .close-modal {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .close-modal:hover {
            background: #c0392b;
        }
        
        /* Message Styling */
        #message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        }
        
        #message div {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        #message .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        #message .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .btn-small {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .form-group h3 {
            background: #3498db;
            color: white;
            padding: 10px;
            margin: 20px 0 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .form-group input::placeholder {
            color: #999;
            font-style: italic;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
        
        /* Enhanced Gallery Upload Styles */
        #galleryUploadPreview {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            margin-bottom: 10px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #galleryUploadPreview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .toolbar {
            margin-bottom: 20px;
            text-align: right;
        }
        
        .toolbar .btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üõçÔ∏è Famms Admin Panel</h1>
                <p>Redirecting to main CMS dashboard...</p>
            </div>
            <button onclick="handleLogout()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                üö™ Logout
            </button>
        </div>
    </div>
    
    <div class="container">
        <div style="text-align: center; padding: 50px;">
            <h2>üöÄ Redirecting to Production CMS</h2>
            <p>This simple admin panel has been replaced with the production Git-based CMS.</p>
            <p>You will be redirected to the main admin dashboard in 3 seconds...</p>
            <div style="margin-top: 20px;">
                <button onclick="window.location.href='/admin/'" style="background: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    Go to Admin Dashboard Now
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Auto redirect to main CMS dashboard
        setTimeout(() => {
            window.location.href = '/admin/';
        }, 3000);
        
        // Authentication check
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on('init', user => {
                if (!user) {
                    window.location.href = '/admin/login.html';
                }
            });
        }
        
        function handleLogout() {
            if (window.netlifyIdentity) {
                window.netlifyIdentity.logout();
            }
        }
    </script>
    
    <!-- Product Modal -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Tambah Produk Baru</h3>
                <button class="close-modal" onclick="closeProductModal()">‚úï</button>
            </div>
            <form id="productModalForm">
                <div class="form-group">
                    <label>Nama Produk</label>
                    <input type="text" id="modal_product_name" required>
                </div>
                <div class="form-group">
                    <label>Harga</label>
                    <input type="text" id="modal_product_price" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <input type="text" id="modal_product_category" required>
                </div>
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="modal_product_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Gambar Produk</label>
                    <div class="image-widget">
                        <div class="image-preview" id="product-preview">
                            <img src="" alt="Product Preview" style="display:none;">
                        </div>
                        <input type="file" class="image-input" id="modal_product_image_file" accept="image/*">
                        <button type="button" class="image-upload-btn" onclick="selectImage('modal_product_image')">üì∑ Pilih Gambar</button>
                        <button type="button" class="image-upload-btn" onclick="clearImage('modal_product_image')">üóëÔ∏è Hapus</button>
                        <div class="image-path" id="modal_product_image_path"></div>
                        <input type="hidden" id="modal_product_image" value="">
                    </div>
                </div>
                <div class="form-group">
                    <label>WhatsApp</label>
                    <input type="text" id="modal_product_wa" placeholder="628123456789">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-small btn-edit" onclick="closeProductModal()">Batal</button>
                    <button type="submit" class="btn-small btn-edit">üíæ Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Gallery Modal -->
    <div id="galleryModal" class="product-modal">
        <div class="product-modal-content">
            <div class="modal-header">
                <h3 id="galleryModalTitle">Add New Gallery Image</h3>
                <button type="button" class="close-modal" onclick="closeGalleryModal()">&times;</button>
            </div>
            <form id="galleryForm">
                <input type="hidden" id="galleryImageId">
                
                <div class="form-group">
                    <label>Upload Image:</label>
                    <div class="image-widget">
                        <div class="image-preview" id="galleryUploadPreview">
                            <img src="" alt="Gallery Preview" style="display:none;">
                        </div>
                        <input type="file" id="galleryImageFile" accept="image/*">
                        <button type="button" class="image-upload-btn" onclick="selectGalleryImage()">üì∑ Choose Image</button>
                        <button type="button" class="image-upload-btn" onclick="clearGalleryImage()">üóëÔ∏è Clear</button>
                        <div class="image-path" id="galleryImagePathDisplay">No file selected</div>
                        <input type="hidden" id="galleryImagePath" name="galleryImagePath" value="">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Image Name:</label>
                    <input type="text" id="galleryImageName" required placeholder="Auto-generated from filename">
                </div>
                
                <div class="form-group">
                    <label>Category:</label>
                    <select id="galleryImageCategory">
                        <option value="gallery">Gallery</option>
                        <option value="product">Product</option>
                        <option value="site">Site</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-small btn-edit" onclick="closeGalleryModal()">Batal</button>
                    <button type="submit" class="btn-small btn-edit">üíæ Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Simple CMS Bridge Script -->
    <script src="../js/simple-cms-bridge.js"></script>
    <script src="../js/simple-gallery.js"></script>
    
    <script>
        // Load existing images saat page load
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof loadExistingImages === 'function') {
                loadExistingImages();
            }
        });
        
        // Gallery Functions
        function showAddGalleryForm() {
            if (!window.simpleGallery) {
                showMessage('‚ùå Simple Gallery not loaded', 'error');
                return;
            }
            
            // Reset form
            document.getElementById('galleryImageId').value = '';
            document.getElementById('galleryImageName').value = '';
            document.getElementById('galleryImagePath').value = '';
            document.getElementById('galleryImagePathDisplay').textContent = 'No file selected';
            document.getElementById('galleryImageCategory').value = 'gallery';
            document.getElementById('galleryModalTitle').textContent = 'Add New Gallery Image';
            
            // Clear preview
            const previewImg = document.querySelector('#galleryUploadPreview img');
            if (previewImg) {
                previewImg.style.display = 'none';
                previewImg.src = '';
            }
            
            document.getElementById('galleryModal').style.display = 'block';
        }
        
        function closeGalleryModal() {
            document.getElementById('galleryModal').style.display = 'none';
        }
        
        function refreshGallery() {
            if (!window.simpleGallery) {
                document.getElementById('gallery-message').innerHTML = '<div class="error">Simple Gallery not loaded</div>';
                return;
            }
            
            try {
                window.simpleGallery.displayImages();
                document.getElementById('gallery-message').innerHTML = '<div class="success">Gallery refreshed successfully (' + window.simpleGallery.getAllImages().length + ' images)</div>';
            } catch (error) {
                document.getElementById('gallery-message').innerHTML = '<div class="error">Error refreshing gallery: ' + error.message + '</div>';
            }
        }
        
        function debugGallery() {
            console.log('=== Gallery Debug Info ===');
            console.log('Simple Gallery available:', !!window.simpleGallery);
            
            if (window.simpleGallery) {
                console.log('Images count:', window.simpleGallery.getAllImages().length);
                console.log('Images:', window.simpleGallery.getAllImages());
            }
        }
        
        // Gallery form submission
        document.addEventListener('DOMContentLoaded', function() {
            const galleryForm = document.getElementById('galleryForm');
            if (galleryForm) {
                galleryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!window.simpleGallery) {
                        showMessage('‚ùå Simple Gallery not available', 'error');
                        return;
                    }
                    
                    const id = document.getElementById('galleryImageId').value;
                    const name = document.getElementById('galleryImageName').value;
                    const path = document.getElementById('galleryImagePath').value;
                    const category = document.getElementById('galleryImageCategory').value;
                    
                    if (!name || !path) {
                        showMessage('‚ùå Please select an image first', 'error');
                        return;
                    }
                    
                    if (id) {
                        // Update existing
                        const success = window.simpleGallery.updateImage(parseInt(id), { name, path, category });
                        if (success) {
                            showMessage('‚úÖ Gallery image updated successfully!');
                        } else {
                            showMessage('‚ùå Failed to update image', 'error');
                        }
                    } else {
                        // Create new
                        window.simpleGallery.addImage({ name, path, category });
                        showMessage('‚úÖ Gallery image added successfully!');
                    }
                    
                    closeGalleryModal();
                });
            }
            
            // File upload handler
            const fileInput = document.getElementById('galleryImageFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewImg = document.querySelector('#galleryUploadPreview img');
                            if (previewImg) {
                                previewImg.src = e.target.result;
                                previewImg.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                        
                        // Generate path and name
                        const timestamp = Date.now();
                        const fileName = file.name.split('.')[0];
                        const fileExt = file.name.split('.').pop();
                        const generatedName = `${fileName}_${timestamp}.${fileExt}`;
                        const generatedPath = `images/uploads/${generatedName}`;
                        
                        document.getElementById('galleryImagePath').value = generatedPath;
                        document.getElementById('galleryImagePathDisplay').textContent = generatedPath;
                        document.getElementById('galleryImageName').value = fileName;
                    }
                });
            }
        });
        
        // File upload functions
        function selectGalleryImage() {
            document.getElementById('galleryImageFile').click();
        }
        
        function clearGalleryImage() {
            document.getElementById('galleryImageFile').value = '';
            document.getElementById('galleryImagePath').value = '';
            document.getElementById('galleryImagePathDisplay').textContent = 'No file selected';
            document.getElementById('galleryImageName').value = '';
            
            const previewImg = document.querySelector('#galleryUploadPreview img');
            if (previewImg) {
                previewImg.style.display = 'none';
                previewImg.src = '';
            }
        }
        
        let currentEditingProduct = null;
        
        // Product Management Functions
        function addNewProduct() {
            currentEditingProduct = null;
            document.getElementById('modalTitle').textContent = 'Tambah Produk Baru';
            document.getElementById('productModalForm').reset();
            document.getElementById('modal_product_image').value = '';
            document.getElementById('modal_product_image_path').textContent = '';
            document.getElementById('product-preview').style.display = 'none';
            document.getElementById('productModal').style.display = 'block';
        }
        
        function editProduct(slug) {
            currentEditingProduct = slug;
            document.getElementById('modalTitle').textContent = 'Edit Produk';
            
            // Load product data
            fetch(`/content/products/${slug}.json`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('modal_product_name').value = product.title || '';
                    document.getElementById('modal_product_price').value = product.price || '';
                    document.getElementById('modal_product_category').value = product.category || '';
                    document.getElementById('modal_product_description').value = product.description || '';
                    document.getElementById('modal_product_wa').value = product.whatsapp || '';
                    document.getElementById('modal_product_image').value = product.image || '';
                    document.getElementById('modal_product_image_path').textContent = product.image || '';
                    
                    // Load image preview
                    if (product.image) {
                        const preview = document.getElementById('product-preview');
                        const img = preview.querySelector('img');
                        img.src = product.image;
                        img.style.display = 'block';
                        preview.style.display = 'block';
                    }
                    
                    document.getElementById('productModal').style.display = 'block';
                })
                .catch(error => {
                    showMessage('‚ùå Error loading product: ' + error.message, 'error');
                });
        }
        
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            currentEditingProduct = null;
        }
        
        // Product form submission
        document.getElementById('productModalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                title: document.getElementById('modal_product_name').value,
                price: document.getElementById('modal_product_price').value,
                category: document.getElementById('modal_product_category').value,
                description: document.getElementById('modal_product_description').value,
                image: document.getElementById('modal_product_image').value,
                whatsapp: document.getElementById('modal_product_wa').value
            };
            
            try {
                const slug = currentEditingProduct || productData.title.toLowerCase().replace(/\s+/g, '-');
                const response = await fetch(`/content/products/${slug}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData, null, 2)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Update products index
                    await updateProductsIndex();
                    
                    showMessage('‚úÖ Produk berhasil ' + (currentEditingProduct ? 'diupdate' : 'ditambahkan') + '!');
                    closeProductModal();
                    loadProducts();
                } else {
                    showMessage('‚ùå Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        });
        
        // Update products index
        async function updateProductsIndex() {
            try {
                const response = await fetch('/content/products/index.json');
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (error) {
                console.log('Error loading products index:', error);
            }
            
            // Create new index if doesn't exist
            return { products: [] };
        }
        
        // Delete product
        async function deleteProduct(slug) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                try {
                    const response = await fetch(`/content/products/${slug}.json`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await updateProductsIndex();
                        showMessage('‚úÖ Produk berhasil dihapus');
                        loadProducts();
                    } else {
                        showMessage('‚ùå Error menghapus produk', 'error');
                    }
                } catch (error) {
                    showMessage('‚ùå Error: ' + error.message, 'error');
                }
            }
        }
        
        // Show section
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionName === 'products') {
                loadProducts();
            }
        }
        
        // Show message
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => messageEl.innerHTML = '', 3000);
        }
        
        // Save about page
        document.getElementById('aboutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                hero_title: document.getElementById('about-hero_title').value,
                hero_subtitle: document.getElementById('about-hero_subtitle').value,
                hero_description: document.getElementById('about-hero_description').value,
                story_title: document.getElementById('story_title').value,
                story_subtitle: document.getElementById('story_subtitle').value,
                story_content: document.getElementById('story_content').value,
                story_content_2: document.getElementById('story_content_2').value,
                story_content_3: document.getElementById('story_content_3').value,
                gallery_title: document.getElementById('gallery_title').value,
                gallery_subtitle: document.getElementById('gallery_subtitle').value,
                gallery_images: [
                    document.getElementById('gallery_image_1').value,
                    document.getElementById('gallery_image_2').value,
                    document.getElementById('gallery_image_3').value,
                    document.getElementById('gallery_image_4').value,
                    document.getElementById('gallery_image_5').value,
                    document.getElementById('gallery_image_6').value,
                    document.getElementById('gallery_image_7').value,
                    document.getElementById('gallery_image_8').value,
                    document.getElementById('gallery_image_9').value,
                    document.getElementById('gallery_image_10').value,
                    document.getElementById('gallery_image_11').value,
                    document.getElementById('gallery_image_12').value
                ],
                cta_title: document.getElementById('cta_title').value,
                cta_description: document.getElementById('cta_description').value
            };
            
            try {
                const response = await fetch('/content/about.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data, null, 2)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ About page saved successfully! Refresh website to see changes.');
                    console.log('About page saved:', data);
                } else {
                    showMessage('‚ùå Failed to save about page: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        });
        
        // Save pages
        document.getElementById('pagesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                hero_title: document.getElementById('hero_title').value,
                hero_subtitle: document.getElementById('hero_subtitle').value,
                hero_description: document.getElementById('hero_description').value,
                arrival_title: document.getElementById('arrival_title').value,
                arrival_description: document.getElementById('arrival_description').value
            };
            
            try {
                const response = await fetch('/content/index.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data, null, 2)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Pages saved successfully! Refresh website to see changes.');
                } else {
                    showMessage('‚ùå Failed to save pages: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        });
        
        // Save settings
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                store_name: document.getElementById('store_name').value,
                store_description: document.getElementById('store_description').value,
                whatsapp_number: document.getElementById('whatsapp_number').value,
                instagram_url: document.getElementById('instagram_url').value,
                facebook_url: document.getElementById('facebook_url').value,
                twitter_url: document.getElementById('twitter_url').value,
                linkedin_url: document.getElementById('linkedin_url').value,
                pinterest_url: document.getElementById('pinterest_url').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value
            };
            
            try {
                const response = await fetch('/content/settings.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data, null, 2)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Settings saved successfully! Refresh website to see changes.');
                    console.log('Settings saved:', data);
                    
                    // Remove problematic postMessage code
                    // The error occurs because we're trying to clone DOM elements
                    // Instead, we'll just show success message
                } else {
                    showMessage('‚ùå Failed to save settings: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        });
        
        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/content/products/index.json');
                if (response.ok) {
                    const data = await response.json();
                    const productList = document.getElementById('productList');
                    productList.innerHTML = '';
                    
                    if (data.products && data.products.length > 0) {
                        for (const file of data.products) {
                            try {
                                const productResponse = await fetch(`/content/products/${file}`);
                                if (productResponse.ok) {
                                    const product = await productResponse.json();
                                    const slug = file.replace('.json', '');
                                    
                                    productList.innerHTML += `
                                        <div class="product-item">
                                            <img src="${product.image}" alt="${product.title}" onerror="this.src='images/default.png'">
                                            <div class="product-info">
                                                <h4>${product.title}</h4>
                                                <p class="price">${product.price}</p>
                                                <p class="category">Kategori: ${product.category}</p>
                                                ${product.description ? `<p class="description">${product.description}</p>` : ''}
                                            </div>
                                            <div class="product-actions">
                                                <button class="btn-small btn-edit" onclick="editProduct('${slug}')">‚úèÔ∏è Edit</button>
                                                <button class="btn-small btn-delete" onclick="deleteProduct('${slug}')">üóëÔ∏è Hapus</button>
                                            </div>
                                        </div>
                                    `;
                                }
                            } catch (error) {
                                console.log('Error loading product:', file, error);
                            }
                        }
                    } else {
                        productList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Belum ada produk. Tambah produk pertama Anda!</p>';
                    }
                } else {
                    productList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 40px;">Error loading products. Silakan coba lagi.</p>';
                }
            } catch (error) {
                console.log('Error loading products:', error);
                document.getElementById('productList').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 40px;">Error loading products. Silakan coba lagi.</p>';
            }
        }
        
        // Image Upload and Preview Functions
        function selectImage(fieldId) {
            const fileInput = document.getElementById(fieldId + '_file');
            fileInput.click();
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadImage(file, fieldId);
                }
            };
        }
        
        // Save testimonial page
        document.getElementById('testimonialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                page_title: document.getElementById('page_title').value,
                section_title: document.getElementById('section_title').value,
                inner_page_title: document.getElementById('inner_page_title').value,
                testimonials: [
                    {
                        name: document.getElementById('testimonial_1_name').value,
                        role: document.getElementById('testimonial_1_role').value,
                        image: "images/client.jpg",
                        content: document.getElementById('testimonial_1_content').value
                    },
                    {
                        name: document.getElementById('testimonial_2_name').value,
                        role: document.getElementById('testimonial_2_role').value,
                        image: "images/client.jpg",
                        content: document.getElementById('testimonial_2_content').value
                    },
                    {
                        name: document.getElementById('testimonial_3_name').value,
                        role: document.getElementById('testimonial_3_role').value,
                        image: "images/client.jpg",
                        content: document.getElementById('testimonial_3_content').value
                    }
                ]
            };
            
            try {
                const response = await fetch('/content/testimonial.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data, null, 2)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Testimonial page saved successfully! Refresh website to see changes.');
                    console.log('Testimonial page saved:', data);
                } else {
                    showMessage('‚ùå Failed to save testimonial page: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        });
        
        // Image Upload and Preview Functions
        function selectImage(fieldId) {
            console.log('selectImage called with fieldId:', fieldId);
            
            const fileInput = document.getElementById(fieldId + '_file');
            
            if (!fileInput) {
                console.error('File input not found:', fieldId + '_file');
                showMessage('‚ùå File input tidak ditemukan', 'error');
                return;
            }
            
            fileInput.click();
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                console.log('File selected:', file);
                
                if (file) {
                    uploadImage(file, fieldId);
                } else {
                    console.log('No file selected');
                }
            };
        }
        
        function uploadImage(file, fieldId) {
            console.log('uploadImage called with fieldId:', fieldId, 'file:', file);
            
            if (!file) {
                console.error('No file provided');
                showMessage('‚ùå Tidak ada file yang dipilih', 'error');
                return;
            }
            
            // Create a unique filename
            const timestamp = Date.now();
            const filename = `${fieldId}_${timestamp}.${file.name.split('.').pop()}`;
            const uploadPath = `${window.CMS_CONFIG.public_folder}/${filename}`;
            
            console.log('Processing file:', filename, 'Upload path:', uploadPath);
            
            // Read file and show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('FileReader loaded, updating preview for:', fieldId);
                
                try {
                    // Update preview with null checking
                    const preview = document.getElementById(fieldId + '-preview');
                    
                    if (!preview) {
                        console.error('Preview element not found:', fieldId + '-preview');
                        showMessage('‚ùå Preview element tidak ditemukan', 'error');
                        return;
                    }
                    
                    const img = preview.querySelector('img');
                    
                    if (!img) {
                        console.error('Image element not found in preview:', fieldId + '-preview img');
                        showMessage('‚ùå Image element tidak ditemukan', 'error');
                        return;
                    }
                    
                    img.src = e.target.result;
                    img.style.display = 'block';
                    preview.style.display = 'block';
                    
                    // Update path with null checking
                    const pathElement = document.getElementById(fieldId + '_path');
                    const hiddenInput = document.getElementById(fieldId);
                    
                    if (!pathElement) {
                        console.error('Path element not found:', fieldId + '_path');
                        showMessage('‚ùå Path element tidak ditemukan', 'error');
                        return;
                    }
                    
                    if (!hiddenInput) {
                        console.error('Hidden input not found:', fieldId);
                        showMessage('‚ùå Hidden input tidak ditemukan', 'error');
                        return;
                    }
                    
                    pathElement.textContent = uploadPath;
                    hiddenInput.value = uploadPath;
                    
                    console.log('Preview updated successfully');
                    // Show success message
                    showMessage('‚úÖ Gambar berhasil diupload: ' + filename, 'success');
                } catch (error) {
                    console.error('Error in uploadImage:', error);
                    showMessage('‚ùå Error processing image: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                showMessage('‚ùå Error reading file', 'error');
            };
            
            reader.readAsDataURL(file);
        }
        
        function clearImage(fieldId) {
            console.log('clearImage called with fieldId:', fieldId);
            
            try {
                const preview = document.getElementById(fieldId + '-preview');
                
                if (!preview) {
                    console.error('Preview element not found:', fieldId + '-preview');
                    showMessage('‚ùå Preview element tidak ditemukan', 'error');
                    return;
                }
                
                const img = preview.querySelector('img');
                
                if (!img) {
                    console.error('Image element not found in preview:', fieldId + '-preview img');
                    showMessage('‚ùå Image element tidak ditemukan', 'error');
                    return;
                }
                
                img.style.display = 'none';
                preview.style.display = 'none';
                
                const pathElement = document.getElementById(fieldId + '_path');
                const hiddenInput = document.getElementById(fieldId);
                
                if (pathElement) {
                    pathElement.textContent = '';
                } else {
                    console.error('Path element not found:', fieldId + '_path');
                }
                
                if (hiddenInput) {
                    hiddenInput.value = '';
                } else {
                    console.error('Hidden input not found:', fieldId);
                }
                
                // Clear file input
                const fileInput = document.getElementById(fieldId + '_file');
                if (fileInput) {
                    fileInput.value = '';
                } else {
                    console.error('File input not found:', fieldId + '_file');
                }
                
                showMessage('üóëÔ∏è Gambar berhasil dihapus', 'success');
                console.log('Image cleared successfully for:', fieldId);
            } catch (error) {
                console.error('Error in clearImage:', error);
                showMessage('‚ùå Error menghapus gambar: ' + error.message, 'error');
            }
        }
        
        // Load existing images on page load
        function loadExistingImages() {
            console.log('Loading existing images...');
            
            for (let i = 1; i <= 12; i++) {
                const fieldId = `gallery_image_${i}`;
                const hiddenInput = document.getElementById(fieldId);
                const pathElement = document.getElementById(fieldId + '_path');
                const preview = document.getElementById(fieldId + '-preview');
                
                if (hiddenInput && hiddenInput.value) {
                    if (pathElement) {
                        pathElement.textContent = hiddenInput.value;
                    }
                    
                    // Try to load existing image
                    if (preview) {
                        const img = preview.querySelector('img');
                        if (img) {
                            img.src = hiddenInput.value;
                            img.onload = function() {
                                preview.style.display = 'block';
                                console.log('Loaded existing image:', fieldId, hiddenInput.value);
                            };
                            img.onerror = function() {
                                // If image doesn't exist, hide preview
                                preview.style.display = 'none';
                                console.log('Failed to load existing image:', fieldId, hiddenInput.value);
                            };
                        } else {
                            console.error('Image element not found in preview:', fieldId + '-preview img');
                        }
                    } else {
                        console.error('Preview element not found:', fieldId + '-preview');
                    }
                } else {
                    console.log('No existing image for:', fieldId);
                }
            }
            
            console.log('Finished loading existing images');
        }
        
        // Test function for debugging
        function testImageUpload() {
            console.log('Testing image upload functionality...');
            
            // Test gallery_image_1
            const fieldId = 'gallery_image_1';
            console.log('Testing field:', fieldId);
            
            const fileInput = document.getElementById(fieldId + '_file');
            const preview = document.getElementById(fieldId + '-preview');
            const pathElement = document.getElementById(fieldId + '_path');
            const hiddenInput = document.getElementById(fieldId);
            
            console.log('Elements found:', {
                fileInput: !!fileInput,
                preview: !!preview,
                pathElement: !!pathElement,
                hiddenInput: !!hiddenInput
            });
            
            if (!fileInput || !preview || !pathElement || !hiddenInput) {
                console.error('Missing elements for:', fieldId);
                showMessage('‚ùå Missing elements for image upload', 'error');
                
                // Log which elements are missing
                if (!fileInput) console.error('Missing fileInput:', fieldId + '_file');
                if (!preview) console.error('Missing preview:', fieldId + '-preview');
                if (!pathElement) console.error('Missing pathElement:', fieldId + '_path');
                if (!hiddenInput) console.error('Missing hiddenInput:', fieldId);
            } else {
                console.log('All elements found successfully');
                
                // Test preview structure
                const img = preview.querySelector('img');
                console.log('Image element in preview:', !!img);
                
                if (!img) {
                    console.error('Image element not found inside preview');
                    showMessage('‚ùå Image element not found inside preview', 'error');
                } else {
                    console.log('Image element found:', img);
                    console.log('Image element src:', img.src);
                    console.log('Image element display:', img.style.display);
                    console.log('Preview element display:', preview.style.display);
                }
                
                showMessage('‚úÖ Image upload elements ready', 'success');
            }
            
            // Test all gallery elements
            console.log('Testing all gallery elements...');
            let allFound = true;
            for (let i = 1; i <= 12; i++) {
                const id = `gallery_image_${i}`;
                const elements = {
                    file: document.getElementById(id + '_file'),
                    preview: document.getElementById(id + '-preview'),
                    path: document.getElementById(id + '_path'),
                    hidden: document.getElementById(id)
                };
                
                const missing = Object.keys(elements).filter(key => !elements[key]);
                if (missing.length > 0) {
                    console.error(`Missing elements for gallery_image_${i}:`, missing);
                    allFound = false;
                }
            }
            
            if (allFound) {
                console.log('‚úÖ All 12 gallery elements found successfully');
                showMessage('‚úÖ All 12 gallery elements ready', 'success');
            } else {
                console.log('‚ùå Some gallery elements are missing');
                showMessage('‚ùå Some gallery elements are missing', 'error');
            }
        }
        
        // Load initial data
        window.addEventListener('load', async () => {
            try {
                // Load pages data using Netlify CMS API
                const pagesData = await window.loadCMSData('index.json');
                if (pagesData) {
                    document.getElementById('hero_title').value = pagesData.hero_title || '';
                    document.getElementById('hero_subtitle').value = pagesData.hero_subtitle || '';
                    document.getElementById('hero_description').value = pagesData.hero_description || '';
                    document.getElementById('arrival_title').value = pagesData.arrival_title || '';
                    document.getElementById('arrival_description').value = pagesData.arrival_description || '';
                }
                
                // Load about data using Netlify CMS API
                const aboutData = await window.loadCMSData('about.json');
                if (aboutData) {
                    document.getElementById('about-hero_title').value = aboutData.hero_title || '';
                    document.getElementById('about-hero_subtitle').value = aboutData.hero_subtitle || '';
                    document.getElementById('about-hero_description').value = aboutData.hero_description || '';
                    document.getElementById('story_title').value = aboutData.story_title || '';
                    document.getElementById('story_subtitle').value = aboutData.story_subtitle || '';
                    document.getElementById('story_content').value = aboutData.story_content || '';
                    document.getElementById('story_content_2').value = aboutData.story_content_2 || '';
                    document.getElementById('story_content_3').value = aboutData.story_content_3 || '';
                    document.getElementById('gallery_title').value = aboutData.gallery_title || '';
                    document.getElementById('gallery_subtitle').value = aboutData.gallery_subtitle || '';
                    document.getElementById('cta_title').value = aboutData.cta_title || '';
                    document.getElementById('cta_description').value = aboutData.cta_description || '';
                }
                
                // Load settings data using Netlify CMS API
                const settingsData = await window.loadCMSData('settings.json');
                if (settingsData) {
                    document.getElementById('store_name').value = settingsData.store_name || '';
                    document.getElementById('store_description').value = settingsData.store_description || '';
                    document.getElementById('whatsapp_number').value = settingsData.whatsapp_number || '';
                    document.getElementById('instagram_url').value = settingsData.instagram_url || '';
                    document.getElementById('facebook_url').value = settingsData.facebook_url || '';
                    document.getElementById('twitter_url').value = settingsData.twitter_url || '';
                    document.getElementById('linkedin_url').value = settingsData.linkedin_url || '';
                    document.getElementById('pinterest_url').value = settingsData.pinterest_url || '';
                    document.getElementById('address').value = settingsData.address || '';
                    document.getElementById('phone').value = settingsData.phone || '';
                    document.getElementById('email').value = settingsData.email || '';
                }
                
                console.log('‚úÖ All data loaded successfully');
                showMessage('‚úÖ Admin panel loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showMessage('‚ö†Ô∏è Using default data (some features may be limited)', 'error');
            }
        });
        
        // Load existing images
        loadExistingImages();
        
        // Test image upload functionality
        setTimeout(() => {
            testImageUpload();
        }, 1000);
        
        // Data management functions
        function handleImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (confirm('This will replace all current data. Are you sure?')) {
                window.importCMSData(file)
                    .then(() => {
                        showMessage('‚úÖ Data imported successfully! Refreshing...', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Import error:', error);
                        showMessage('‚ùå Failed to import data', 'error');
                    });
            }
            
            // Reset file input
            event.target.value = '';
        }
        
        // Authentication check for admin/simple.html
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on('init', user => {
                if (!user) {
                    // User not logged in, redirect to login page
                    console.log('User not authenticated, redirecting to login...');
                    window.location.href = '/admin/login.html';
                } else {
                    // User logged in, show admin panel
                    console.log('User authenticated:', user.email);
                }
            });
            
            window.netlifyIdentity.on('logout', () => {
                // User logged out, redirect to login page
                window.location.href = '/admin/login.html';
            });
        } else {
            // Netlify Identity not available, redirect to login
            console.log('Netlify Identity not available, redirecting to login...');
            window.location.href = '/admin/login.html';
        }
        
        function handleLogout() {
            if (window.netlifyIdentity) {
                window.netlifyIdentity.logout();
            }
        }
    </script>
</body>
</html>
